<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I am Composer</title>

</head>

<body>
    <script src="js/piano.js"></script>
    <link href="css/piano.css" type="text/css" rel="stylesheet">
    <div class="canvas-container">
        <canvas id="canvasElement">
        </canvas>
        <div class="score-container">
            <div id="score">

            </div>
            <button onclick="playScore()">play</button>
            <button onclick="cleanScore()">clean</button>
        </div>
    </div>
    <div id="osmdContainer"></div>

    <div id="all">
        <h1 style="width:100%;text-align:center;"></h1>

        <!--主要代码-->
        <div id="piano">
            <div id="key60" class="key whiteKey"></div>
            <div id="key62" class="key whiteKey"></div>
            <div id="key64" class="key whiteKey"></div>
            <div id="key65" class="key whiteKey"></div>
            <div id="key67" class="key whiteKey"></div>
            <div id="key69" class="key whiteKey"></div>
            <div id="key71" class="key whiteKey"></div>
        </div>
        <div id="comment"></div>
    </div>
    <div class="visual-container">
        <div class="inner-container">
            <div class="visualization do"></div>
            <div class="visualization do" id="do"></div>
            <div class="visualization do"></div>
            <div class="visualization re"></div>
            <div class="visualization re" id="re"></div>
            <div class="visualization re"></div>
            <div class="visualization me"></div>
            <div class="visualization me" id="me"></div>
            <div class="visualization me"></div>
            <div class="visualization fa"></div>
            <div class="visualization fa" id="fa"></div>
            <div class="visualization fa"></div>
            <div class="visualization so"></div>
            <div class="visualization so" id="so"></div>
            <div class="visualization so"></div>
            <div class="visualization la"></div>
            <div class="visualization la" id="la"></div>
            <div class="visualization la"></div>
            <div class="visualization xi"></div>
            <div class="visualization xi" id="xi"></div>
            <div class="visualization xi"></div>
        </div>
    </div>
</body>

<script type="text/javascript" src="./js/jquery.min.js"></script>
<script type="text/javascript" src="./js/main.js"></script>
<script src="js/opensheetmusicdisplay.min.js"></script>

<!-- <script>
    var s = "";
    $.ajax({
        url: 'http://localhost:5000/get_musicxml',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify([0]),
        async: false,
        success: (data) => {
            s = data;
        }
    });
    var osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdContainer");
    osmd.setOptions({
        backend: "svg",
        drawTitle: true,
        // drawingParameters: "compacttight" // don't display title, composer etc., smaller margins
    });
    osmd
        .load("http://127.0.0.1:5501/frontend/assets/test3.xml")
        .then(
            function () {
                osmd.render();
            }
        );
</script> -->

<script>
    function play(note) {
        let src = "./assets/" + note + '.mp3';
        let audio = new Audio(src);
        let list = ['do', 're', 'me', 'fa', 'so', 'la', 'xi'];
        let index = list.indexOf(note);
        // document.getElementsByClassName("box")[index].style.height = "100px";
        $("#" + note).height(100);
        let noteList = document.getElementsByClassName(note);
        $("." + note + ":first").height(100 * Math.random());
        $("." + note + ":eq(2)").height(100 * Math.random());
        audio.play();
        setTimeout(() => {
            // document.getElementsByClassName("box")[index].style.height = "5px";
            $("." + note).height(5);
            let noteList = document.getElementsByClassName(note);
        }, 300);
    }
</script>

<script>
    var record = [];
    function addRecord(note) {
        let list = ['do', 're', 'me', 'fa', 'so', 'la', 'xi'];
        record.push(list.indexOf(note) + 1);
        let text = "";
        for (let i = 0; i < record.length; i++) {
            text += record[i] + " ";
        }
        document.getElementById("score").innerHTML = text;
        // 更新五线谱
        var s = "";
        $.ajax({
            url: 'http://localhost:5000/get_musicxml',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(record),
            success: (data) => {
                var osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdContainer");
                osmd.setOptions({
                    backend: "svg",
                    drawTitle: true,
                    // drawingParameters: "compacttight" // don't display title, composer etc., smaller margins
                });
                osmd
                    .load(data)
                    .then(
                        function () {
                            osmd.render();
                        }
                    );
            }
        });
        // var osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdContainer");
        // osmd.setOptions({
        //     backend: "svg",
        //     drawTitle: true,
        //     // drawingParameters: "compacttight" // don't display title, composer etc., smaller margins
        // });
        // osmd
        //     .load(s)
        //     .then(
        //         function () {
        //             osmd.render();
        //         }
        //     );
    }

    async function playScore() {
        for (let i = 0; i < record.length; i++) {
            let list = ['do', 're', 'me', 'fa', 'so', 'la', 'xi'];
            let key_list = ['60', '62', '64', '65', '67', '69', '71'];
            playSound(key_list[record[i] - 1]);
            await sleep(300);
        }
    }

    function sleep(time) {
        return new Promise((resolve) => setTimeout(resolve, time));
    }

    function cleanScore() {
        record = [];
        document.getElementById("score").innerHTML = "";
    }
</script>

<style>
    .canvas-container {
        display: flex;
        width: 449;
        height: 449;
        flex-grow: 0;
        flex-direction: row;
        justify-content: space-around;
    }

    #all {
        border: solid 0px #333;
        margin: 100px auto;
    }

    .visualization {
        height: 5px;
        border-radius: 2px;
        width: 50px;
        transition: 0.8s ease-out;
        margin: 1px;
        background: #ff6e7f;
        /* fallback for old browsers */
        background: linear-gradient(to top, #ff6e7f, #bfe9ff);

    }

    .piano {
        display: flex;
    }

    .visual-container {
        display: flex;
        height: 100px;
        flex-direction: column-reverse;
        align-items: center;
    }

    .inner-container {
        display: flex;
        flex-direction: row;
        height: 100px;
        align-items: flex-end;
    }

    #score {
        border: solid 1px black;
        width: 300px;
        height: 300px;
    }
</style>

</html>